<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multi-Agent Dating Simulation</title>
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css"/>
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2c3e50;
      --background-color: #fcfcfc;
      --text-color: #34495e;
      --border-color: #bdc3c7;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      font-size: 14px;
      background-color: var(--background-color);
      color: var(--text-color);
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .game-container {
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      background-color: var(--background-color);
      padding: 20px;
      padding-top: 40px;
    }
    .message {
      max-width: 70%;
      padding: 8px 12px;
      margin: 2px 0;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4;
    }
    .message.user-agent {
      background-color: var(--primary-color);
      color: white;
    }
    .message.other-agent {
      background-color: #e5e5ea;
      color: #000000;
    }
    .start-page {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    button {
      font-size: 14px;
      padding: 8px 16px;
      margin-right: 10px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #2980b9;
    }
    button:disabled {
      background-color: var(--border-color);
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Multi-Agent Dating Simulation</h1>
    <div id="start-page" class="start-page">
      <div class="form-group">
        <label for="agent-name">Select Your Agent:</label>
        <select id="agent-name" required>
          <!-- Options for agent names will be populated here -->
        </select>
      </div>
      <div class="form-group">
        <label for="date-context">Describe the Date Context:</label>
        <textarea id="date-context" placeholder="e.g., first date at a coffee shop" rows="4" required></textarea>
      </div>
      <button id="start-dates">Start Dates</button>
    </div>
    <div id="game-page" style="display: none;">
      <div class="controls">
        <button id="reset-game">Reset</button>
        <button id="download-log" style="display: none;">Download Log</button>
      </div>
      <div id="date-log-container" class="game-container"></div>
    </div>
  </div>

  <script>
    const startPage = document.getElementById('start-page');
    const gamePage = document.getElementById('game-page');
    const dateLogContainer = document.getElementById('date-log-container');
    const startDatesBtn = document.getElementById('start-dates');
    const resetGameBtn = document.getElementById('reset-game');
    const downloadLogBtn = document.getElementById('download-log');
    const agentNameSelect = document.getElementById('agent-name');
    const dateContextInput = document.getElementById('date-context');

    // Populate agent names in the select element
    const agentList = ["Joon", "Carolyn", "Helena", "Michael", "Percy"];
    agentList.forEach(agent => {
      const option = document.createElement('option');
      option.value = agent;
      option.textContent = agent;
      agentNameSelect.appendChild(option);
    });

    function displayDateLog(dateLogs) {
      console.log("Displaying date logs...");
      dateLogContainer.innerHTML = '';
      dateLogs.split('\n').forEach(log => {
        const logEntry = document.createElement('div');
        logEntry.className = 'message other-agent';
        logEntry.textContent = log;
        dateLogContainer.appendChild(logEntry);
      });
      dateLogContainer.scrollTop = dateLogContainer.scrollHeight;
    }

    startDatesBtn.addEventListener('click', () => {
      const userAgentName = agentNameSelect.value;
      const dateContext = dateContextInput.value.trim();

      if (!userAgentName || !dateContext) {
        alert('Please select an agent and describe the date.');
        return;
      }

      console.log("Starting dates with selected agent:", userAgentName);
      fetch('/start_dates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: userAgentName,
          context: dateContext
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          startPage.style.display = 'none';
          gamePage.style.display = 'block';
          fetchDates();
        } else {
          alert('Failed to start the simulation. Please try again.');
        }
      });
    });

    function fetchDates() {
      console.log("Fetching dates...");
      fetch('/run_dates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(response => response.json())
      .then(data => {
        console.log("Received date logs:", data);
        if (data.date_logs) {
          displayDateLog(data.date_logs);
          downloadLogBtn.style.display = 'inline-block';
        } else {
          alert('Error fetching date logs.');
        }
      })
      .catch(error => {
        console.error("Error in fetchDates:", error);
      });
    }

    resetGameBtn.addEventListener('click', () => {
      console.log("Resetting game...");
      fetch('/reset', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'reset') {
            dateLogContainer.innerHTML = '';
            startPage.style.display = 'block';
            gamePage.style.display = 'none';
            downloadLogBtn.style.display = 'none';
          }
        });
    });

    downloadLogBtn.addEventListener('click', () => {
      window.location.href = '/download_log';
    });
  </script>
</body>
</html>